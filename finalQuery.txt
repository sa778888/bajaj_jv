WITH paid AS (
  SELECT DISTINCT EMP_ID
  FROM PAYMENTS
  WHERE AMOUNT > 70000
),
eligible AS (
  SELECT
    d.DEPARTMENT_ID,
    d.DEPARTMENT_NAME,
    e.EMP_ID,
    e.FIRST_NAME,
    e.LAST_NAME,
    TIMESTAMPDIFF(YEAR, e.DOB, CURDATE()) AS AGE,
    ROW_NUMBER() OVER (
        PARTITION BY d.DEPARTMENT_ID 
        ORDER BY e.EMP_ID
    ) AS RN
  FROM EMPLOYEE e
  JOIN DEPARTMENT d ON e.DEPARTMENT = d.DEPARTMENT_ID
  JOIN paid p ON p.EMP_ID = e.EMP_ID
),
limited AS (
  SELECT
    DEPARTMENT_ID,
    GROUP_CONCAT(CONCAT(FIRST_NAME, ' ', LAST_NAME) ORDER BY EMP_ID SEPARATOR ', ') AS EMPLOYEE_LIST
  FROM eligible
  WHERE RN <= 10
  GROUP BY DEPARTMENT_ID
),
agg_age AS (
  SELECT
    DEPARTMENT_ID,
    ROUND(AVG(AGE), 2) AS AVERAGE_AGE
  FROM eligible
  GROUP BY DEPARTMENT_ID
)
SELECT
  d.DEPARTMENT_NAME,
  a.AVERAGE_AGE,
  COALESCE(l.EMPLOYEE_LIST, '') AS EMPLOYEE_LIST
FROM DEPARTMENT d
LEFT JOIN agg_age a ON a.DEPARTMENT_ID = d.DEPARTMENT_ID
LEFT JOIN limited l ON l.DEPARTMENT_ID = d.DEPARTMENT_ID
ORDER BY d.DEPARTMENT_ID DESC;